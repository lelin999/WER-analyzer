var extract = require('pdf-text-extract')

var extractRound      = require('./utils/extractRound')
var extractTableRows  = require('./utils/extractTableRows')
var extractColumnData = require('./utils/extractColumnData')
var extractedRowData  = require('./utils/extractRowData')
var isValidReporterFile  = require('./utils/isValidReporterFile')

function parser (filePath, callback) {
  extract(filePath, (err, text) => {
    if (err) {
      callback(err)
      return
    }

    var lines = text.join('').split('\n')
    if (!isValidReporterFile(lines)) {
      callback("Error: This doesn't appear to be a Wizards Event Reporter pdf")
      return
    }

    var round      = extractRound(lines)

    var tableRows  = extractTableRows(lines)
  //   { head: 'Table   Player              DCI          Opponent            DCI',
  // body: [ '2       Adamant, Daghatar   1234123450   Zarek, Ral          1234567813   9-6', ...etc] }
    var columnData = extractColumnData(tableRows)
  //   [ { index: 0, start: 0, end: 8, name: 'Table' },
  // { index: 1, start: 8, end: 28, name: 'Player' },
  // { index: 2, start: 28, end: 41, name: 'DCI' },
  // { index: 3, start: 41, end: 61, name: 'Opponent' },
  // { index: 4, start: 61, end: 74, name: 'DCI' },
  // { index: 5, start: 74, end: 80, name: 'Points' } ]
    var rowData    = extractedRowData(tableRows.body, columnData)
    //'9       Adamant, Daghatar   1234123450   Sengir, Irini       1231231248   3-0'
    //'17      Gunnarson, Axelrod 1234123401    Demon, Griselbrand 1231231210    3-0
    //'18      Merciless, Kaervek 1231231283    Zhong, Huang        1231231236   3-0'

    callback(null, rowData, round)
  })
}

module.exports = parser